<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Payer</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: -apple-system, sans-serif; background: #22272e; color: #adbac7; text-align: center; padding: 20px; height: 100vh; display: flex; flex-direction: column; align-items: center; margin: 0; }
        
        /* Name Input Styling */
        .settings-bar { width: 100%; max-width: 400px; margin-bottom: 15px; display: flex; flex-direction: column; align-items: flex-start; }
        .settings-label { font-size: 12px; color: #888; margin-bottom: 5px; margin-left: 5px;}
        #user-name-input { width: 95%; padding: 10px; font-size: 16px; border-radius: 8px; border: none; background: #444c56; color: #adbac7; outline: none; }
        
        /* Camera & Button Styling */
        #reader { width: 100%; max-width: 400px; border-radius: 20px; overflow: hidden; border: 2px solid #444c56; flex-grow: 1; background: #111; margin: 10px 0; }
        #status { margin-top: 10px; color: #666; font-size: 14px; }
        
        .btn { padding: 15px; width: 95%; max-width: 400px; border-radius: 10px; border: none; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-start { background: #3783fd; color: white; margin-bottom: 20px; }

        /* Modal Styling (unchanged) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10; flex-direction: column; justify-content: center; align-items: center; }
        .card { background: #2d333b; color: white; padding: 30px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; }
        .price-tag { font-size: 40px; font-weight: bold; color: #58a6ff; margin: 10px 0; }
        .btn-confirm { background: #34C759; color: white; }
        .btn-cancel { background: #FF3B30; color: white; }
    </style>
</head>
<body>

    <div class="settings-bar">
        <label class="settings-label">YOUR NAME</label>
        <input type="text" id="user-name-input" placeholder="Enter your name here..." oninput="saveName()">
    </div>

    <button class="btn btn-start" id="start-btn" onclick="startScanner()">Activate Camera Scanner</button>

    <div id="reader" style="display:none;"></div>
    <p id="status">Tap the button above to start scanning.</p>

    <div id="confirmation-modal" class="modal">
        <div class="card">
            <h2 id="vendor-name">Vendor</h2>
            <div class="price-tag" id="price-display">$0.00</div>
            <p>Confirm Payment?</p>
            <button class="btn btn-confirm" onclick="confirmPayment()">Pay Now</button>
            <button class="btn btn-cancel" onclick="resetScanner()">Cancel</button>
        </div>
    </div>

    <script>
        // === SUPABASE INITIALIZATION (unchanged) ===
        const SUPABASE_URL = 'https://oljybvueyqlyvxwxsosl.supabase.co'; // REMINDER: REPLACE
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sanlidnVleXFseXZ4d3hzb3NsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDQzNTgsImV4cCI6MjA3OTE4MDM1OH0.Y7OsLUmfEOeA855K-UxhzqXOkrOzII0zDm_qU8GnVqM'; // REMINDER: REPLACE
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const html5QrCode = new Html5Qrcode("reader");
        let scannedData = null;

        // Load saved name on startup (unchanged)
        window.onload = function() {
            const savedName = localStorage.getItem('qr_payer_name');
            if (savedName) {
                document.getElementById('user-name-input').value = savedName;
            } else {
                document.getElementById('user-name-input').value = "Guest";
            }
        };

        // Save name whenever user types (unchanged)
        function saveName() {
            const name = document.getElementById('user-name-input').value;
            localStorage.setItem('qr_payer_name', name);
        }

        // NEW FUNCTION: Starts the Scanner on button click
        function startScanner() {
            // 1. Hide the button and show the reader
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('reader').style.display = 'block';
            document.getElementById('status').innerText = 'Starting Camera...';

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // 2. Start the camera
            html5QrCode.start({ facingMode: "environment" }, config, 
                (decodedText) => {
                    // Success callback (runs on successful scan)
                    try {
                        const data = JSON.parse(decodedText);
                        if(data.vendorId && data.amount) {
                            html5QrCode.stop().then(() => {
                                showConfirmation(data);
                            });
                        }
                    } catch(e) {
                        // Ignore non-payment QR codes
                    }
                },
                (errorMessage) => {
                    // Error callback (optional for logging)
                }
            ).catch(err => {
                // Catches permission denied or camera access failure
                document.getElementById('status').innerText = 'Camera access failed. Ensure permission is granted.';
                document.getElementById('reader').style.display = 'none';
                document.getElementById('start-btn').style.display = 'block';
            });
        }
        
        function showConfirmation(data) {
            scannedData = data;
            document.getElementById('vendor-name').innerText = "Vendor Terminal"; 
            document.getElementById('price-display').innerText = "$" + data.amount;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        async function confirmPayment() {
            const payerName = document.getElementById('user-name-input').value || "Unknown Guest";
            document.querySelector('.btn-confirm').innerText = "Processing...";

            const { data, error } = await supabase
                .from('transactions')
                .insert([
                    { 
                        vendor_id: scannedData.vendorId, 
                        amount: scannedData.amount, 
                        payer_name: payerName
                    },
                ])
                .select(); 

            if (error) {
                alert('Payment failed: ' + error.message);
                console.error(error);
                document.querySelector('.btn-confirm').innerText = "Try Again";
            } else {
                alert("Payment Sent and Recorded!");
                location.reload(); 
            }
        }

        function resetScanner() {
            location.reload();
        }

        // NOTE: The previous automatic start on load is removed, replaced by startScanner()
    </script>
</body>
</html>
